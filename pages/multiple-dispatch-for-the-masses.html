<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Multiple Dispatch for the Masses</title>
        <link rel="stylesheet" href="http://brainscrape.github.io/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://brainscrape.github.io/">Brainscrape </a></h1>
                <nav><ul>
                    <li class="active"><a href="http://brainscrape.github.io/pages/multiple-dispatch-for-the-masses.html">Multiple Dispatch for the Masses</a></li>
                    <li><a href="http://brainscrape.github.io/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
    <h1 class="entry-title">Multiple Dispatch for the Masses</h1>
    
    <p>Popular modern day languages used by most programmers have progressed from perdominately procedural/imperative to single dispatch object oriented.  Most mainstream languages also incorporate functional and generic programming to a limited extent as well. We will worry only about the most common subset of features for this article.</p>
<p>The most common methods of dealing with multiple dispatch using these languages and features will be shown.  Keep in mind that these have been discovered through my own research and experience, so read through this with a critical mind, and be sure to diversify your sources on this topic.</p>
<p>This entry will utilize two languages with which most programmers will have at least a passing familiarity: C and Java.</p>
<h1>What is Multiple Dispatch?</h1>
<p>Code is often written against abstractions.  These abstractions are helpful in the development process, but they all must eventually be resolved to a concrete type in order to do actual work.</p>
<h2>A Single Dispatch Example</h2>
<p>As a quick example from an object oriented language, an <code>Animal</code> abstraction may provide a <code>speak</code> method.  A programmer may write:</p>
<div class="highlight"><pre><span class="n">animal</span><span class="o">.</span><span class="na">speak</span><span class="o">();</span>
</pre></div>


<p>This line of code has no real meaning, though.  If an Animal is a purely abstract object, then its <code>speak</code> method will have no actual code.  At runtime, the program will dynamically dispatch to object's underlying type and call that object's <code>speak</code> method.  In other words, if the abstract <code>animal</code> object points to an instance of <code>Dog</code> class, then the above call may print <code>woof</code> to the screen.</p>
<p>In this case, the actual code called is determined by the underlying type of one abstraction.  One abstraction leads to a single dispatch.  The mechanism by which this (usually?) happens will be discussed in the procedural/imperative section.</p>
<h1>A Multiple Dispatch Example</h1>
<p>At times it my be necessary to dispatch based on multiple types.</p>
<p>A programmer writing a game of rock-paper-scissors might use an abstraction of <code>Attacker</code> to represent a potential move.  This abstraction could prove useful throughout the program.  When the actual game is played, though, the type of both attackers will need to be known.  What we <em>want</em> to write is something along the lines of:</p>
<div class="highlight"><pre><span class="o">(</span><span class="n">attacker1</span> <span class="n">and</span> <span class="n">attacker2</span><span class="o">).</span><span class="na">determineWinner</span><span class="o">();</span>
</pre></div>


<p>As an example, attacker1 might be resolved to <code>Rock</code> and attacker2 might be resolved to <code>Scissors</code>.  In this case, the code relating to rock beating scissors would be called.</p>
<h1>Multiple Dispatch in C</h1>
<p>There are two main ways to go about this in C.  Both of these involve defining types which explicitly describe themselves.  In other words, an enum may be defined as:</p>
<div class="highlight"><pre><span class="k">enum</span> <span class="p">{</span> <span class="n">ROCK</span><span class="p">,</span> <span class="n">PAPER</span><span class="p">,</span> <span class="n">SCISSORS</span><span class="p">}</span> <span class="n">attacker</span><span class="p">;</span>
</pre></div>


<p>The types for each attack could be defined by:</p>
<div class="highlight"><pre><span class="k">struct</span> <span class="p">{</span> <span class="n">attacker</span> <span class="n">TYPE</span> <span class="o">=</span> <span class="n">ROCK</span><span class="p">;</span> <span class="p">}</span>
<span class="k">struct</span> <span class="p">{</span> <span class="n">attacker</span> <span class="n">TYPE</span> <span class="o">=</span> <span class="n">PAPER</span><span class="p">;</span> <span class="p">}</span>
<span class="k">struct</span> <span class="p">{</span> <span class="n">attacker</span> <span class="n">TYPE</span> <span class="o">=</span> <span class="n">SCISSORS</span><span class="p">;</span> <span class="p">}</span>
</pre></div>


<h2>Big Switch Statement</h2>
<p>The typically cringeworthy solution is to have a Big Switch Statement to handle every possible combination.  In psuedocode, for sanity related reasons:</p>
<div class="highlight"><pre><span class="k">switch</span> <span class="n">attacker1</span><span class="p">.</span><span class="nl">TYPE</span><span class="p">:</span>
  <span class="k">case</span> <span class="nl">ROCK</span><span class="p">:</span>
    <span class="k">switch</span> <span class="n">attacker2</span><span class="p">.</span><span class="nl">TYPE</span><span class="p">:</span>
      <span class="k">case</span> <span class="nl">ROCK</span><span class="p">:</span> <span class="n">tie</span>
      <span class="k">case</span> <span class="nl">PAPER</span><span class="p">:</span> <span class="n">lose</span>
      <span class="k">case</span> <span class="nl">SCISSORS</span><span class="p">:</span> <span class="n">win</span>
  <span class="k">case</span> <span class="nl">PAPER</span><span class="p">:</span>
    <span class="k">switch</span> <span class="n">attacker2</span><span class="p">.</span><span class="nl">TYPE</span><span class="p">:</span>
      <span class="k">case</span> <span class="nl">ROCK</span><span class="p">:</span> <span class="n">win</span>
      <span class="n">etc</span><span class="p">...</span>
  <span class="n">etc</span><span class="p">...</span>
</pre></div>


<p>This switch statement ends up being huge, even with only three types.</p>
<p>Beyond factoring each switch and/or case statement into its own function, the switch statement itself may be replaced with a jump table.</p>
<h2>Big Jump Table</h2>
<p>The logic of a switch statement or chain of if/else statements based on explicitly defined types may be replaced by a jump table.  Before diving into the code, imagine a matrix of possible outcomes for the game itself:</p>
<table>
<thead>
<tr>
<th>-</th>
<th>Rock</th>
<th>Paper</th>
<th>Scissors</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Rock</strong></td>
<td>Tie</td>
<td>Lose</td>
<td>Win</td>
</tr>
<tr>
<td><strong>Paper</strong></td>
<td>Win</td>
<td>Tie</td>
<td>Lose</td>
</tr>
<tr>
<td><strong>Scissors</strong></td>
<td>Lose</td>
<td>Win</td>
<td>Tie</td>
</tr>
</tbody>
</table>
<p>We can translate this into code by creating functions for every possible combination of rock-paper-scissors, then populating a table based on the intersection of the types.  Dispatching to the correct function can then be done by looking up the function pointer in the table:</p>
<div class="highlight"><pre><span class="n">BattleFunction</span> <span class="n">generate_outcome</span> <span class="o">=</span> <span class="n">gameMatrix</span><span class="p">[</span><span class="n">attacker1</span><span class="p">.</span><span class="n">TYPE</span><span class="p">,</span> <span class="n">attacker2</span><span class="p">.</span><span class="n">TYPE</span><span class="p">];</span>
<span class="n">generate_outcome</span><span class="p">();</span>
</pre></div>


<p>Maintaining the <code>TYPE</code> field in all of our objects is still a bit of a pain.  If we were to add or remove any types, we would have to edit our enum and update our matrix.</p>
<h1>Introspection</h1>
<p>While finding a language or environment in which introspection is unavailable is not unheard of, reflection is commonly used to help alleviate some of the issues with the C-based approaches to this problem.</p>
<p>Instead of manually tracking each type, the underlying type of each abstraction is determined via a language's introspection features, and then the relevant code is dispatched to based on the findings.</p>
<p>As a side note, this approach is often times discovered independently and immediatelly touted as a panacea for the ugly switch/table based methods previously described, and the also ugly double indirection used in object oriented languages.  It is my opinion that it is not.  While it does simplify some aspects of the table-based approach, it still carries many of the drawbacks associated with that method, and it introduces many of its own drawbacks in the process.  These will be detailed in the general compare/contrast of each method toward the end.</p>
<h1>Object Oriented Approach</h1>
<p>In object oriented languages, polymorphism is the go-to mechanism for replacing branches (be they switch or if) based on type.  To implement double dispatch, then, one can write something along the lines of:</p>
<div class="highlight"><pre><span class="n">attacker1</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">attacker2</span><span class="o">);</span>
</pre></div>


<p>This dispatches to the appropriate <code>handle1 method based on attacker1's type.  If</code>attacker1<code>is a</code>rock`, for example, you could mentally translate this to:</p>
<div class="highlight"><pre><span class="n">rock</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">attacker2</span><span class="o">);</span>
</pre></div>


<p>Since we're now in the Rock's <code>handle</code> method, we know we are a rock.  Now all that's left to do is figure out what attacker2 is.  We can do this in similar fasion inside of the rock.handle method:</p>
<div class="highlight"><pre><span class="n">attacker2</span><span class="o">.</span><span class="na">handleRock</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</pre></div>


<p>We know that we're a <code>rock</code>, so <code>this</code> is really <code>rock</code>.  Again, if <code>attacker2</code> is <strong>actually</strong> <code>paper</code>, the call may be mentally translated to:</p>
<div class="highlight"><pre><span class="n">paper</span><span class="o">.</span><span class="na">handleRock</span><span class="o">(</span><span class="n">rock</span><span class="o">)</span>
</pre></div>


<p>And in our Paper class, the handleRock method can contain the code which handles the rock versus paper interaction.</p>
<h3>Header 3</h3>
<blockquote>
<p>This is a blockquote.</p>
<p>This is the second paragraph in the blockquote.</p>
<h2>This is an H2 in a blockquote</h2>
</blockquote>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>